---
output: 
  html_document:
    css: www/styles.css
    anchor_sections: FALSE
    includes:
        in_header: "header_manual.html"
params:
  year: 2019
  plot: "ROVA-009"
---
<div style="margin-left:-120px;width:100%">
QAQC Report for: <span style="font-weight:bold;">`r params$plot` `r params$year`</span> {.tabset .tabset-pills}
--------------------------------------------------
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(knitr.kable.NA = '')
```

```{r import, include = FALSE, cache = TRUE}
forestNETN::importData()
```

```{r deps, include = FALSE}
library(tidyverse)
library(forestNETN)
library(htmltools)
library(knitr)
library(kableExtra)

# Set up params (tends to work better)
year = as.numeric(params$year)
plot = params$plot

source("QAQC_functions.R")
```

```{r compile_data, include = FALSE}
source("Compile_QAQC_Data.R")
```

```{r stand_tables, include = FALSE}
site_char_tab <- kable(stand2 %>% select(Team, Stand_Structure, Txt_Crown_Closure, Water_on_Plot, 
                              Deer_Browse_Index, Microtopography, Earthworms), 
                       format = "html", align = 'c',
                       col.names = c("Team", "Stand Structure" ,"Crown Closure", "Water on Plot", 
                                     "Deer Browse Index", "Microtopography", "Earthworms")) %>% 
                 kable_styling(fixed_thead = TRUE, bootstrap_options = 'condensed', 
                               position = 'float_left', font_size = 14) %>% 
                 row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
                 row_spec(1:2, extra_css = 'border-bottom: 1px solid #CACACA;') %>% 
                 column_spec(2, background = check_dif(stand2, "Stand_Structure")) %>% 
                 column_spec(3, background = check_dif(stand2, "Crown_Closure_code")) %>% 
                 column_spec(4, background = check_dif(stand2, "Water_on_Plot")) %>% 
                 column_spec(5, background = check_dif(stand2, "Deer_Browse_Index")) %>% 
                 column_spec(6, background = check_dif(stand2, "Microtopography")) %>% 
                 column_spec(7, background = check_dif(stand2, "Earthworms")) %>% 
                 row_spec(nrow(stand2), extra_css = "border-bottom: 1px solid #000000;")

pct_tab <- kable(stand2 %>% select(Team, Txt_Understory_Low, Txt_Understory_Mid, Txt_Understory_High,
                                   Txt_Bare_Soil, Txt_Rock, Txt_Trampled, Txt_Water,
                                   Txt_Bryophyte, Txt_Lichen),
                 format = 'html', align = 'c',
                 col.names = c("Team", "% Vasc. Low", "% Vasc. Mid", "% Vasc. High", 
                               "% Bare Soil", "% Rock", "% Trampled", "% Water",
                               "% Non-Vascular", "% Lichen")) %>% 
                 kable_styling(fixed_thead = TRUE, bootstrap_options = 'condensed', 
                               position = 'float_left', font_size = 14) %>% 
                 row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
                 row_spec(1:2, extra_css = 'border-bottom: 1px solid #CACACA;') %>%
                 column_spec(2, background = check_dif(stand2, "Understory_Low_code")) %>% 
                 column_spec(3, background = check_dif(stand2, "Understory_Mid_code")) %>% 
                 column_spec(4, background = check_dif(stand2, "Understory_High_code")) %>% 
                 column_spec(5, background = check_dif(stand2, "Bare_Soil_code")) %>% 
                 column_spec(6, background = check_dif(stand2, "Rock_code")) %>% 
                 column_spec(7, background = check_dif(stand2, "Trampled_code")) %>% 
                 column_spec(8, background = check_dif(stand2, "Water_code")) %>% 
                 column_spec(9, background = check_dif(stand2, "Bryophyte_code")) %>% 
                 column_spec(10, background = check_dif(stand2, "Lichen_code")) %>% 
                 row_spec(nrow(stand2), extra_css = "border-bottom: 1px solid #000000;")

trht_tab <- kable(tree_hts_wide %>% select(TagCode, CrownClassLabel, Crew, QAQC, ht_diff),
                  format = 'html', align = 'c',
                  table.attr = "style='width:48%;'",
                  col.names = c("Tree #", "Crown Class", "Crew", "QAQC", "Diff (m)")) %>% 
            kable_styling(fixed_thead = TRUE, bootstrap_options = 'condensed', full_width = FALSE, 
                          position = 'left', font_size = 14) %>% 
                  row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
                  row_spec(1:(nrow(tree_hts_wide)-1), extra_css = 'border-bottom: 1px solid #CACACA;') %>%
                  column_spec(3:5, background = case_when(tree_hts_wide$ht_diff > 1 ~ diff_bad,
                                                        between(tree_hts_wide$ht_diff, 0.2, 1) ~ diff_ok,
                                                        between(tree_hts_wide$ht_diff, 0, 0.2) ~ '#ffffff',
                                                        is.na(tree_hts_wide$ht_diff) ~ diff_bad,
                                                        TRUE ~ "#ffffff")) %>% 
                  row_spec(nrow(tree_hts_wide), extra_css = "border-bottom: 1px solid #000000;")

dist_tab <- kable(dist %>% select(Team, DisturbanceSummary, ThresholdLabel, DisturbanceCoverClassLabel),
                  format = 'html', align = 'c',
                  table.attr = "style='width:48%;'",
                  col.names = c("Team", "Disturbance", "Threshold", "Cover Class")) %>% 
            kable_styling(fixed_thead = TRUE, bootstrap_options = 'condensed', full_width = FALSE, 
                          position = 'left', font_size = 14) %>% 
                  row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
                  row_spec(1:2, extra_css = 'border-bottom: 1px solid #CACACA;') %>%
                  column_spec(2, background = check_dif(dist, "DisturbanceLabel")) %>% 
                  column_spec(3, background = check_dif(dist, "ThresholdLabel")) %>% 
                  column_spec(4, background = check_dif(dist, "DisturbanceCoverClassCode")) %>% 
                  row_spec(nrow(dist), extra_css = "border-bottom: 1px solid #000000;")

```

```{r tree_tables, include = FALSE}
tree_tab <- kable(tree_wide2 %>% select(-fol_diff, -dec_diff, -HWA_diff, -BBD_diff), 
                  format = 'html', align = 'c',
                  col.names = c("Tree", "Species", "DBH_C", "DBH_Q", "Diff", "Ver_C", "Ver_Q",
                                "Status_C", "Status_Q", "Crown_C", "Crown_Q", "TotFol_C", "TotFol_Q",
                                "Decay_C", "Decay_Q", "HWA_C", "HWA_Q", "BBD_C", "BBD_Q")) %>% 
            kable_styling(fixed_thead = TRUE, bootstrap_options = 'condensed', 
                          full_width = FALSE, position = 'left', font_size = 13) %>% 
            row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
            row_spec(1:nrow(tree_wide2), extra_css = 'border: 1px solid #CACACA;') %>% 
            column_spec(2, border_right = TRUE) %>% 
            column_spec(3:5, background = check_dbh(tree_wide2, "DBH_diff")) %>% 
            column_spec(seq(5, 19, 2), border_right = TRUE) %>% 
            column_spec(6:7, background = 
                          ifelse(!tree_wide2$IsDBHVerified_C %in% tree_wide2$IsDBHVerified_Q, diff_ok, "#ffffff")) %>% 
            column_spec(8:9, background = 
                          case_when(substr(tree_wide2$TreeStatusCode_C, 1, 1) != "R" &
                                    substr(tree_wide2$TreeStatusCode_C, 1, 1) != 
                                      substr(tree_wide2$TreeStatusCode_Q, 1, 1) ~ diff_bad,
                                    substr(tree_wide2$TreeStatusCode_C, 1, 1) != "R" &
                                    tree_wide2$TreeStatusCode_C != tree_wide2$TreeStatusCode_Q ~ diff_ok,
                                    TRUE ~ "#ffffff")) %>% 
            column_spec(10:11, background = 
                          case_when(abs(tree_wide2$CrownClassCode_C - tree_wide2$CrownClassCode_Q) > 1 ~ diff_bad,
                                    abs(tree_wide2$CrownClassCode_C - tree_wide2$CrownClassCode_Q) == 1 ~ diff_ok,
                                    TRUE ~ "#ffffff")) %>% 
            column_spec(12:13, background = 
                          case_when(tree_wide$fol_diff > 1 ~ diff_bad,
                                    tree_wide$fol_diff == 1 ~ diff_ok,
                                    TRUE ~ "#ffffff")) %>% 
            column_spec(14:15, background = 
                          case_when(tree_wide2$dec_diff > 1 ~ diff_bad,
                                    tree_wide2$dec_diff == 1 ~ diff_ok,
                                    TRUE ~ "#ffffff")) %>% 
            column_spec(16:17, background = 
                          case_when(tree_wide2$HWA_diff > 1 ~ diff_bad,
                                    tree_wide2$HWA_diff == 1 ~ diff_ok,
                                    TRUE ~ "#ffffff")) %>% 
            column_spec(18:19, background = 
                          case_when(tree_wide2$BBD_diff > 1 ~ diff_bad,
                                    tree_wide2$BBD_diff == 1 ~ diff_ok,
                                    TRUE ~ "#ffffff"))  %>% 
            row_spec(nrow(tree_wide2), extra_css = "border-bottom: 1px solid #000000;")

trcond_tab <- kable(trcond_wide %>% select(-cond_diff), 
                    format = 'html', align = 'c',
                    col.names = c("Tree", "#Cond_C", "#Cond_Q", names(trcond_wide[,5:46]),
                                  "VOB_C", "VOB_Q", "VINC_C", "VINC_Q")) %>% 
              kable_styling(fixed_thead = TRUE, bootstrap_options = 'condensed', 
                            full_width = FALSE, position = 'left', font_size = 12) %>% 
                    row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
                    row_spec(1:nrow(trcond_wide), extra_css = 'border: 1px solid #CACACA;') %>% 
                    row_spec(nrow(trcond_wide), extra_css = "border-bottom: 1px solid #000000;") %>%
                    column_spec(1, border_left = TRUE, border_right = TRUE, 
                                extra_css = "border-left: 1px solid #000000; border-right: 2px solid #000000;") %>%
                    column_spec(3, border_right = TRUE, extra_css = "border-right: 2px solid #000000;") %>% 
                    column_spec(2:3, background = case_when(trcond_wide$cond_diff > 1 ~ diff_bad,
                                                            trcond_wide$cond_diff == 1 ~ diff_ok,
                                                            trcond_wide$cond_diff == 0 ~ "#ffffff",
                                                            TRUE ~ "#ffffff"), 
                                bold = TRUE) %>%
                    column_spec(4:5, background = check_cond(trcond_wide, "H_C", "H_Q")) %>% 
                    column_spec(4, border_left = TRUE) %>% column_spec(5, border_right = TRUE) %>%
                    column_spec(6:7, background = check_cond(trcond_wide, "NO_C", "NO_Q")) %>% 
                    column_spec(seq(7, 49, 2), border_right = TRUE) %>%
                    column_spec(8:9,   background = check_cond(trcond_wide, "AD_C", "AD_Q")) %>% 
                    column_spec(10:11, background = check_cond(trcond_wide, "BBD_C", "BBD_Q")) %>% 
                    column_spec(12:13, background = check_cond(trcond_wide, "BC_C", "BC_Q")) %>% 
                    column_spec(14:15, background = check_cond(trcond_wide, "BWA_C", "BWA_Q")) %>% 
                    column_spec(16:17, background = check_cond(trcond_wide, "CAVL_C", "CAVL_Q")) %>% 
                    column_spec(18:19, background = check_cond(trcond_wide, "CAVS_C", "CAVS_Q")) %>% 
                    column_spec(20:21, background = check_cond(trcond_wide, "CW_C", "CW_Q")) %>% 
                    column_spec(22:23, background = check_cond(trcond_wide, "DBT_C", "DBT_Q")) %>% 
                    column_spec(24:25, background = check_cond(trcond_wide, "DOG_C", "DOG_Q")) %>% 
                    column_spec(26:27, background = check_cond(trcond_wide, "EAB_C", "EAB_Q")) %>% 
                    column_spec(28:29, background = check_cond(trcond_wide, "EB_C", "EB_Q")) %>% 
                    column_spec(30:31, background = check_cond(trcond_wide, "EHS_C", "EHS_Q")) %>% 
                    column_spec(32:33, background = check_cond(trcond_wide, "G_C", "G_Q")) %>% 
                    column_spec(34:35, background = check_cond(trcond_wide, "GM_C", "GM_Q")) %>% 
                    column_spec(36:37, background = check_cond(trcond_wide, "HWA_C", "HWA_Q")) %>% 
                    column_spec(38:39, background = check_cond(trcond_wide, "ID_C", "ID_Q")) %>% 
                    column_spec(40:41, background = check_cond(trcond_wide, "OTH_C", "OTH_Q")) %>% 
                    column_spec(42:43, background = check_cond(trcond_wide, "RPS_C", "RPS_Q")) %>% 
                    column_spec(44:45, background = check_cond(trcond_wide, "SB_C", "SB_Q")) %>% 
                    column_spec(46:47, background = check_cond(trcond_wide, "VIN_B_C", "VIN_B_Q")) %>% 
                    column_spec(48:49, background = check_cond(trcond_wide, "VIN_C_C", "VIN_C_Q")) %>% 
                    scroll_box(width = "1100px")

folcond_tab <- kable(folcond_wide %>% select(TagCode:Txt_Leaves_Aff_W_Q), 
                     format = 'html', align = 'c',
                     col.names = c("Tree", "C_Lvs_C", "C_Lvs_Q", "C_LAr_C", "C_LAr_Q",
                                   "H_Lvs_C", "H_Lvs_Q", "H_LAr_C", "H_LAr_Q",
                                   "L_Lvs_C", "L_Lvs_Q", 
                                   "N_Lvs_C", "N_Lvs_Q", "N_LAr_C", "N_LAr_Q",
                                   "O_Lvs_C", "O_Lvs_Q", 
                                   "S_Lvs_C", "S_Lvs_Q", 
                                   "W_Lvs_C", "W_Lvs_Q")) %>% 
              kable_styling(fixed_thead = TRUE, bootstrap_options = 'condensed', 
                            full_width = FALSE, position = 'left', font_size = 13) %>% 
                    row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
                    row_spec(1:nrow(folcond_wide), extra_css = 'border: 1px solid #CACACA;') %>% 
                    row_spec(nrow(folcond_wide), extra_css = "border-bottom: 1px solid #000000;") %>%
                    column_spec(1, border_left = TRUE, border_right = TRUE, 
                                extra_css = "border-left: 1px solid #000000; border-right: 1px solid #000000;") %>%
                    column_spec(2:3, background = check_covclass(folcond_wide, "Leaves_Aff_C_code_C", "Leaves_Aff_C_code_Q")) %>% 
                    column_spec(seq(3, 21, 2), border_right = TRUE) %>% 
                    column_spec(4:5, background = check_covclass(folcond_wide, "Leaf_Area_C_code_C", "Leaf_Area_C_code_Q")) %>% 
                    column_spec(6:7, background = check_covclass(folcond_wide, "Leaves_Aff_H_code_C", "Leaves_Aff_H_code_Q")) %>% 
                    column_spec(8:9, background = check_covclass(folcond_wide, "Leaf_Area_H_code_C", "Leaf_Area_H_code_Q")) %>% 
                    column_spec(10:11, background = check_covclass(folcond_wide, "Leaves_Aff_L_code_C", "Leaves_Aff_L_code_Q")) %>% 
                    column_spec(12:13, background = check_covclass(folcond_wide, "Leaves_Aff_N_code_C", "Leaves_Aff_N_code_Q")) %>% 
                    column_spec(14:15, background = check_covclass(folcond_wide, "Leaf_Area_N_code_C", "Leaf_Area_N_code_Q")) %>% 
                    column_spec(16:17, background = check_covclass(folcond_wide, "Leaves_Aff_O_code_C", "Leaves_Aff_O_code_Q")) %>% 
                    column_spec(18:19, background = check_covclass(folcond_wide, "Leaves_Aff_S_code_C", "Leaves_Aff_S_code_Q")) %>% 
                    column_spec(20:21, background = check_covclass(folcond_wide, "Leaves_Aff_W_code_C", "Leaves_Aff_W_code_Q")) %>% 
                    scroll_box(width = "1100px")
  
# After I've built out all of the tabs, find a way to put a second header to help break up the column names b/t cond and QAQC

```

```{r micro_tables, include = FALSE}
sap_tab <- kable(saps, format = 'html', align = 'c', #table.attr = "style='width:48%;'",
                 col.names = c("Team", "SQ", "Micro", "Species", "DBH")) %>% 
           kable_styling(fixed_thead = TRUE, bootstrap_options = 'condensed', 
                         full_width = TRUE, position = 'left', font_size = 14) %>% 
           row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
           row_spec(1:nrow(saps), extra_css = 'border: 1px solid #CACACA;') %>% 
           row_spec(nrow(saps), extra_css = "border-bottom: 1px solid #000000;") %>% 
           column_spec(1:ncol(saps), background = ifelse(saps$Team == "Crew", "#ffffff", "#DADADA")) %>% 
           column_spec(1, border_left = TRUE) %>% column_spec(5, border_right = TRUE)
           
sap_sum_tab <- kable(sap_sum %>% select(-dbh_diff), format = 'html', align = 'c', #table.attr = "style='width:48%;'",
                     col.names = c("Micro", "#Saps_C", "#Saps_Q", "DBH_mean_C", "DBH_mean_Q")) %>% 
               kable_styling(fixed_thead = TRUE, bootstrap_options = "condensed", 
                             full_width = TRUE, position = 'left', font_size = 14) %>% 
               row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
               row_spec(1:nrow(sap_sum), extra_css = 'border: 1px solid #CACACA;') %>% 
               row_spec(nrow(sap_sum), extra_css = "border-bottom: 1px solid #000000;") %>% 
               column_spec(1, border_left = TRUE) %>% 
               column_spec(2:3, background = check_stems(sap_sum, "num_saps_Crew", "num_saps_QAQC")) %>% 
               column_spec(4:5, background = check_dbh(sap_sum, "dbh_diff")) %>% 
               column_spec(seq(1, 5, 2), border_right = TRUE) 

row_changes <- sapply(seq_along(shrubs_full), function(x){
  check = ifelse(shrubs_full$Micro[x] != shrubs_full$Micro[x + 1], x, NA)
  }) %>% data.frame() %>% na.omit(.) 

shrub_tab <- kable(shrubs_full %>% select(-pct_class_C, -pct_class_Q), format = 'html', align = 'c',
                   col.names = c("Micro", "Species", "% Cover C", "% Cover Q")) %>% 
             kable_styling(fixed_thead = TRUE, bootstrap_options = "condensed", 
                           full_width = TRUE, position = 'left', font_size = 14) %>% 
             column_spec(3:4, background = check_covclass(shrubs_full, "pct_class_C", "pct_class_Q")) %>% 
             row_spec(c(0, nrow(shrubs_full)), extra_css = "border-bottom: 1px solid #000000;") %>% 
             row_spec(row_changes[,1], extra_css = "border-bottom: 1px solid #000000;")

row_changes2 <- sapply(seq_along(seeds_comp), function(x){
  check = ifelse(seeds_comp$MicroplotCode[x] != seeds_comp$MicroplotCode[x + 1], x, NA)
  }) %>% data.frame() %>% na.omit(.) 

seeds_tab <- kable(seeds_comp %>% select(-tot_seeds_C, -tot_seeds_Q), format = 'html', align = 'c', 
                   col.names = c("Micro", "Species", "15-30cm_C", "15-30cm_Q", "30-100cm_C", "30-100cm_Q",
                                 "100-150cm_C", "100-150cm_Q", ">150cm_C", ">150cm_Q")) %>% 
             kable_styling(fixed_thead = TRUE, bootstrap_options = "condensed", 
                           full_width = TRUE, position = 'left', font_size = 14) %>% 
             column_spec(c(1, seq(2, 10, 2)), border_right = TRUE) %>%
             column_spec(seq(3, 9, 2), border_right = TRUE, extra_css = 'border-right: 1px solid #CACACA;') %>% 
             column_spec(2, background = ifelse(!(seeds_comp$ScientificName %in% "None present") & 
                                                 (seeds_comp$tot_seeds_C == 0 | seeds_comp$tot_seeds_Q == 0), 
                                                diff_bad, "#ffffff")) %>% 
             column_spec(3:4, background = check_stems_small(seeds_comp, "sd_15_30cm_C", "sd_15_30cm_Q")) %>% 
             column_spec(5:6, background = check_stems(seeds_comp, "sd_30_100cm_C" ,"sd_30_100cm_Q")) %>% 
             column_spec(7:8, background = check_stems(seeds_comp, "sd_100_150cm_C" ,"sd_100_150cm_Q")) %>% 
             column_spec(5:6, background = check_stems(seeds_comp, "sd_p150cm_C" ,"sd_p150cm_Q")) %>% 
             row_spec(c(0, nrow(seeds_comp)), extra_css = "border-bottom: 1px solid #000000;") %>% 
             row_spec(row_changes2[,1], extra_css = "border-bottom: 1px solid #000000;")

regen_tab <- kable(regen_comp, format = 'html', align = 'c',
                   col.names = c("Species", 
                                 "Tot_Seeds_C", "Tot_Seeds_Q", "Tot_Saps_C", "Tot_Saps_Q", 
                                 "Stocking_C", "Stocking_Q")) %>% 
             kable_styling(fixed_thead = TRUE, bootstrap_options = "condensed", 
                           full_width = TRUE, position = 'left', font_size = 14) 

```
### Stand {.tabset .tabset-pills}

<h3>Stand Characteristics</h3>
```{r, echo = FALSE}
site_char_tab
```
<br>

<h3>Stand % Cover Metrics</h3>
```{r, echo = FALSE}
pct_tab
```
<br>

<div class='column_1'>
<h3>Stand Height</h3>
```{r, echo = FALSE}
trht_tab
```
</div>

<div class='column_2'>
<h3>Disturbances</h3>
```{r, echo = FALSE}
dist_tab
```
</div>


### Tree {.tabset}

#### Tree Data {.tabset}
```{r, tree_table, echo = FALSE}
tree_tab
```

#### Conditions
```{r, cond_table, echo = FALSE}
trcond_tab
```

#### Foliage Conditions
```{r, fol_table, echo = FALSE}
folcond_tab
```

### Microplot{.tabset}

#### Saplings {.tabset}
<details open><summary><h3>Individual Stems</h3></summary>
```{r, sap_table, echo = FALSE}
sap_tab
```
</details>

<details open><summary><h3>Summary</h3></summary>
```{r, sap_sum, echo = FALSE}
sap_sum_tab
```
</details>

#### Shrubs {.tabset}
<details open><summary><h3>Shrubs</h3></summary>
```{r, shrub_table, echo = FALSE}
shrub_tab
```
</details>

#### Seedlings {.tabset}
<details open><summary><h3>Individual Stems</h3></summary>
```{r, seed_table, echo = FALSE}
seeds_tab
```
</details>



### Quadrat Data

### Quadrat Species

### Add. Spp.

### CWD

### Soil

</div>
