---
output: 
  html_document:
    css: www/styles.css
    anchor_sections: FALSE
    includes:
        in_header: "header_manual.html"
params:
  year: 2019
  plot: "ACAD-047"
---
QAQC Report for: <span style="font-weight:bold;">`r params$plot` `r params$year`</span> {.tabset .tabset-pills}
--------------------------------------------------

```{r setup, include = FALSE, cache = TRUE}
knitr::opts_chunk$set(echo = FALSE)

forestNETN::importData()
```

```{r deps, include = FALSE}
library(tidyverse)
library(forestNETN)
library(htmltools)
library(knitr)
library(kableExtra)

# Set up params (tends to work better)
year = as.numeric(params$year)
plot = params$plot

#---- Functions 
filter_plot <- function(df){filter(df, Plot_Name %in% params$plot & StartYear %in% params$year)}
name_team <- function(df){mutate(df, Team = ifelse(IsQAQC == 0, "Crew", "QAQC"))}

diff_ok <- "#F2F2A0" #yellow
diff_bad <- "#F5BA59" #orange

check_dif <- function(df, col){
  dif <- ifelse(is.numeric(df[, col]), 
                abs(diff(df[, col])), 
                df[1,col] == df[2,col])

  color <- case_when(is.logical(dif) & dif == TRUE ~ "#ffffff", #white
                     is.logical(dif) & dif == FALSE ~ diff_ok,
                     is.numeric(dif) & dif == 0 ~ "#ffffff", 
                     is.numeric(dif) & dif == 1 ~ diff_ok,
                     is.numeric(dif) & dif > 1 ~ diff_bad,
                     is.na(dif) ~ "#ffffff") 
  return(color)
}

add_covcode <- function(df, col, jointbl){
  var_name <- paste0(substr(col, 5, nchar(col)), "_code")
  df2 <- merge(df, jointbl, by.x = col, by.y = 'txt') 
  names(df2)[names(df2) == "pct_class"] <- var_name
  return(df2 %>% select(var_name))
}

```

```{r compile_data, include = FALSE}
arglist = list(park = params$park, from = year, to = year, QAQC = TRUE, eventType = 'complete')

plotevs <- do.call(joinLocEvent, arglist) %>% filter_plot() %>% name_team()

qaqc_eid <- plotevs$EventID[plotevs$IsQAQC == TRUE]
crew_eid <- plotevs$EventID[plotevs$IsQAQC == FALSE]

stand <- do.call(joinStandData, c(arglist, list(output = 'verbose'))) %>% filter_plot() %>% name_team()

dist <- do.call(joinStandDisturbance, arglist) %>% filter_plot() %>% name_team()

crown_cov <- data.frame(txt = c("<10%", "10-25%", "25-50%", "50-75%", "75-100%", "PM"),
                        pct_class = c(1, 2, 3, 4, 5, 6))

stand_cov <- data.frame(txt = c("0%", "1-5%", "5-25%", "25-50%", "50-75%", "75-95%", "95-100%", "PM"),
                        pct_class = c(0, 1, 2, 3, 4, 5, 6, 7))

code_cols <- c("Txt_Understory_Low", "Txt_Understory_Mid", "Txt_Understory_High", 
               "Txt_Bare_Soil", "Txt_Bryophyte", "Txt_Lichen", "Txt_Rock", "Txt_Trampled", 
               "Txt_Water")

stand2 <- do.call(cbind, c(stand, 
                           add_covcode(stand, "Txt_Crown_Closure", crown_cov),
                           lapply(seq_along(code_cols), function(x){
                                  add_covcode(stand, code_cols[x], stand_cov)}))) 

tree_hts <- get("COMN_StandTreeHeights", envir = VIEWS_NETN) %>% 
  select(ParkUnit, PlotCode, StartYear, IsQAQC, CrownClassLabel, TagCode, Height) %>% 
  mutate(Plot_Name = paste(ParkUnit, stringr::str_pad(PlotCode, 3, side = 'left', '0'), sep = "-")) %>% 
  filter_plot() %>% name_team() %>% select(-IsQAQC)

tree_hts_wide <- tree_hts %>% pivot_wider(names_from = Team,
                                          values_from = Height) %>% 
                              mutate(ht_diff = Crew - QAQC)



```
```{r stand_tables, include = FALSE}

site_char_tab <- kable(stand2 %>% select(Team, Stand_Structure, Txt_Crown_Closure, Water_on_Plot, 
                              Deer_Browse_Index, Microtopography, Earthworms), 
                       format = "html", align = 'c',
                       col.names = c("Team", "Stand Structure" ,"Crown Closure", "Water on Plot", 
                                     "Deer Browse Index", "Microtopography", "Earthworms")) %>% 
                 kable_styling(fixed_thead = TRUE, bootstrap_options = 'condensed') %>% 
                 row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
                 row_spec(1:2, extra_css = 'border-bottom: 1px solid #CACACA;') %>% 
                 column_spec(2, background = check_dif(stand2, "Stand_Structure")) %>% 
                 column_spec(3, background = check_dif(stand2, "Crown_Closure_code")) %>% 
                 column_spec(4, background = check_dif(stand2, "Water_on_Plot")) %>% 
                 column_spec(5, background = check_dif(stand2, "Deer_Browse_Index")) %>% 
                 column_spec(6, background = check_dif(stand2, "Microtopography")) %>% 
                 column_spec(7, background = check_dif(stand2, "Earthworms"))

pct_tab <- kable(stand2 %>% select(Team, Txt_Understory_Low, Txt_Understory_Mid, Txt_Understory_High,
                                   Txt_Bare_Soil, Txt_Rock, Txt_Trampled, Txt_Water,
                                   Txt_Bryophyte, Txt_Lichen),
                 format = 'html', align = 'c',
                 col.names = c("Team", "% Vasc. Low", "% Vasc. Mid", "% Vasc. High", 
                               "% Bare Soil", "% Rock", "% Trampled", "% Water",
                               "% Non-Vascular", "% Lichen")) %>% 
                 kable_styling(fixed_thead = TRUE, bootstrap_options = 'condensed') %>% 
                 row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
                 row_spec(1:2, extra_css = 'border-bottom: 1px solid #CACACA;') %>%
                 column_spec(2, background = check_dif(stand2, "Understory_Low_code")) %>% 
                 column_spec(3, background = check_dif(stand2, "Understory_Mid_code")) %>% 
                 column_spec(4, background = check_dif(stand2, "Understory_High_code")) %>% 
                 column_spec(5, background = check_dif(stand2, "Bare_Soil_code")) %>% 
                 column_spec(6, background = check_dif(stand2, "Rock_code")) %>% 
                 column_spec(7, background = check_dif(stand2, "Trampled_code")) %>% 
                 column_spec(8, background = check_dif(stand2, "Water_code")) %>% 
                 column_spec(9, background = check_dif(stand2, "Bryophyte_code")) %>% 
                 column_spec(10, background = check_dif(stand2, "Lichen_code")) 

trht_tab <- kable(tree_hts_wide %>% select(TagCode, CrownClassLabel, Crew, QAQC, ht_diff),
                  format = 'html', align = 'c',
                  table.attr = "style='width:48%;'",
                  col.names = c("Tree #", "Crown Class", "Crew", "QAQC", "Diff (m)")) %>% 
            kable_styling(fixed_thead = TRUE, bootstrap_options = 'condensed', full_width = FALSE, position = 'left') %>% 
                  row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
                  row_spec(1:2, extra_css = 'border-bottom: 1px solid #CACACA;') %>%
                  column_spec(5, background = case_when(abs(tree_hts_wide$ht_diff) > 1 ~ diff_bad,
                                                        between(abs(tree_hts_wide$ht_diff), 0.1, 1) ~ diff_ok,
                                                        tree_hts_wide$ht_diff == 0 ~ '#ffffff')
                  )
dist_tab <- kable(dist %>% select(Team, DisturbanceSummary, ThresholdLabel, DisturbanceCoverClassLabel),
                  format = 'html', align = 'c',
                  table.attr = "style='width:48%;'",
                  col.names = c("Team", "Disturbance", "Threshold", "Cover Class")) %>% 
            kable_styling(fixed_thead = TRUE, bootstrap_options = 'condensed', full_width = FALSE, position = 'left') %>% 
                  row_spec(0, extra_css = 'border-bottom: 1px solid #000000;') %>% 
                  row_spec(1:2, extra_css = 'border-bottom: 1px solid #CACACA;') %>%
                  column_spec(2, background = check_dif(dist, "DisturbanceLabel")) %>% 
                  column_spec(3, background = check_dif(dist, "ThresholdLabel")) %>% 
                  column_spec(4, background = check_dif(dist, "DisturbanceCoverClassCode")) 

```

### Stand {.tabset}

<h3>Stand Characteristics</h3>
```{r, echo = FALSE}
site_char_tab
```
<br>
<h3>Stand % Cover Metrics</h3>
```{r, echo = FALSE}
pct_tab
```
<br>

<div class='column_1'>
<h3>Stand Height</h3>
```{r, echo = FALSE}
trht_tab
```
</div>

<div class='column_2'>
<h3>Disturbances</h3>
```{r, echo = FALSE}
dist_tab
```
</div>

### Tree

### Microplot

### Quadrat Data

### Quadrat Species

### Add. Spp.

### CWD

### Soil


